In the realm of information retrieval and machine learning, the selection and evaluation of text fragments, known as “chunks,” are crucial for obtaining precise and relevant results. One of the advanced methods for performing this task is the Retrieval-Augmented Generation (RAG) method. This method integrates search and response generation by combining pretrained language models with information retrieval techniques.When utilizing the RAG method, it is essential to conduct an effective search to find the most pertinent text chunks in relation to a given query. The appropriate selection of these fragments depends not only on data labeling techniques but also on the use of similarity and relevance metrics tailored to the specific use case. The choice of an appropriate metric can significantly influence the quality of the results obtained.In this article, we will explore how the nature of the query can determine the choice of the most suitable metric for evaluating the similarity and relevance of text chunks. We will focus on two widely used metrics: Cosine Similarity and Maximal Marginal Relevance (MMR). We will explain their mathematical foundations, their applications, and compare their performance in different search and information retrieval scenariosLabeling the Question and ChunksLabeling the question and chunks is a fundamental process in Retrieval-Augmented Generation (RAG) to ensure that the search and selection of text fragments are precise and efficient. This process involves assigning labels to both the question and the text chunks, allowing for better alignment between the query and the relevant fragments.How labeling is doneLabeling begins with assigning a list of possible labels to the question. This can be done in two main ways:Manual Labeling by the User: The user can directly provide the labels they consider relevant for the question.Automated Classification Techniques: Natural language processing models, such as fine-tuning a BERT model for multi-class classification, can be employed. This approach allows the system to automatically assign labels based on the content of the question.Additionally, the text chunks are also labeled using the same techniques. These labels reflect the content and context of each chunk, facilitating a more precise and efficient search.Benefits of LabelingFiltering Out Unnecessary Chunks: Labeling the chunks helps filter out fragments that are not relevant to the question at hand. By assigning specific labels to the chunks, we can quickly identify which ones do not contain pertinent information and exclude them from the search process. This significantly reduces noise and improves the efficiency of the retrieval system.Improved Search Precision: By labeling both the question and the chunks, a more focused and precise search can be conducted. The labels act as indicators of relevance, allowing the RAG system to concentrate on the fragments that contain information directly related to the query. This ensures that only the most relevant chunks are considered, improving the quality of the generated responses.Optimization of Processing Time: Eliminating unnecessary chunks not only improves precision but also optimizes processing time. With fewer fragments to evaluate, the system can perform searches and generate responses more quickly, which is crucial in real-time applications.Metrics for Effective Chunk Evaluation in RAGChoosing the right metrics is crucial in the Retrieval-Augmented Generation (RAG) method to ensure the most relevant and precise chunks of text are selected. Two widely used metrics for this purpose are Cosine Similarity and Maximal Marginal Relevance (MMR). Understanding and applying these metrics appropriately can significantly impact the effectiveness of the RAG system.Cosine Similarity is a measure that evaluates the similarity between two vectors, which, in the context of RAG, translates to measuring the similarity between the vector representation of the question and the vector representation of the text chunks. It is defined as:A·B is the dot product of vectors A and B.?A? and ?B? are the magnitudes (or norms) of vectors A and B, respectively.Maximal Marginal Relevance (MMR)MMR is a metric that combines the relevance of documents with respect to a query and the diversity among the selected documents. The formula for MMR is:where:R is the set of relevant documents.S is the set of already selected documents.D_i? and D_j? are documents in the set.sim(D_i,Q) is the similarity between document D_i? and query Q, typically measured by Cosine Similarity.? is a parameter that controls the balance between relevance and diversity.max sim(D_i?,D_j?) for D_j??S? measures the maximum similarity between document D_i? and any already selected document D_j.Mathematical ComparisonDirect Relevance vs. Relevance and DiversityCosine Similarity: Measures direct relevance between two vectors based on their orientation in the vector space.MMR: Considers both relevance sim(D_i,Q) and diversity max(sim(D_i,D_j?) among selected documents.Focus on DiversityCosine Similarity: Ignores diversity among chunks and focuses solely on direct similarity to the query.MMR: Introduces a term (1-?)·max(?sim(D_i,D_j) to penalize the selection of documents that are very similar to each other, thus promoting diversity.Balance Controlled by ?In MMR, the parameter ? allows adjusting the weight between relevance and diversity. When ? is close to 1, MMR behaves more like Cosine Similarity, prioritizing relevance. When ? is smaller, more weight is given to diversity.Cosine Similarity does not have such an adjustment parameter and always measures direct similarity.Optimization vs. Direct MeasurementCosine Similarity: A direct and simple measure of similarity, calculated once for each pair of vectors.MMR: An iterative optimization process, selecting the next document D_i that maximizes a combination of relevance and diversity at each step.Visualizing Chunk Relevance with PCAFigure 1: PCA and Coordinate Transformation for Question and Chunks SimilarityTo better understand the relationship between the question and the chunks, we can employ PCA (Principal Component Analysis) to visualize the high-dimensional data in a two-dimensional space. This helps in illustrating how chunks are positioned relative to the question based on their cosine similarity.In the provided image:Green Points: Represent chunks of text plotted according to their cosine similarity to the question.Red Points: Indicate chunks selected based on MMR, ensuring both high relevance and diversity.Blue Point: Represents the question or the central query.Blue Ellipse: Represents a similarity threshold, indicating the range of chunks considered closely similar to the question.Technical BreakdownPCA Transformation:The high-dimensional vectors representing the question and chunks are reduced to two dimensions using PCA. This transformation helps in visualizing the spatial relationships among the chunks and the question.The blue point in the center represents the question after PCA transformation.Cosine Similarity Mapping:The chunks are plotted based on their cosine similarity to the question. Chunks closer to the blue point (the question) have higher cosine similarity, indicating higher relevance.The inverse mapping ensures that chunks with higher similarity scores are positioned closer to the center.The blue ellipse shows the similarity threshold, highlighting chunks within a certain range of similarity. In this case is 0.65 score.MMR Selection:The red points represent chunks selected based on the MMR criterion. These chunks are not only relevant to the question but also diverse, covering different aspects of the query.In this PCA, the question focuses on documents specialized in engineering. Many chunks that we needed and that contained the relevant keywords would have been very useful. However, by using MMR, we lost these chunks with high semantic similarity. This highlights the importance of studying the nature of the question, as making good queries to the language model (LLM) and understanding its background helps improve our RAG technique.It is essential to understand that different types of questions may require different approaches to chunk selection. For instance, for highly specific and technical questions, such as those related to engineering, Cosine Similarity might be more effective as it focuses on direct relevance and specific keywords. On the other hand, for more general questions, MMR provides better results by balancing the relevance and diversity of the selected chunks.Importance of the Nature of the QuestionUnderstanding the nature of the question is crucial for the success of the RAG technique. Well-formulated and specific questions help the language model provide more precise and useful answers. By knowing the context and requirements of the question, we can better select the appropriate metrics and methods for information retrieval.In summary, while Cosine Similarity is excellent for specific queries with clear keywords, MMR is more suitable for general queries that require a broader range of information. Evaluating and understanding the nature of each question allows us to improve the effectiveness of our information retrieval techniques, ensuring that we select the most relevant and diverse chunks for each query.